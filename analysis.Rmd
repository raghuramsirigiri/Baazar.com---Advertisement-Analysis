---
title: "Difference-in-Differences – Bazaar.com"
author: Raghuram Sirigiri
fontsize: 12pt
output:
  pdf_document: default
  html_notebook: default

---

# Business Overview

US retailer Bazaar uses both display and search advertising running paid search ads on Google and Yahoo. Bazaar releases its ads in response to key words used by customers and are classified broadly into Branded(such as ‘Bazaar’, ‘Bazaar shoes’, ‘Bazaar clothes’ and so on) and Non Branded keywords(such as ‘shoes’, ‘dress’ that do not contain ‘Bazaar’).

Using data from Google and Bing, Bazaar’s marketing analytics team computed an ROI of 320% on their sponsored ad spending. But were skeptical because some the the user who searched bazaar might already have the intent visit Bazaar.com. This is an confusion they would like the analyst to clear. The goal is to understand the causal effect of the search ads.

__Question to be answered:__

1. What is wrong with Bob’s ROI analysis?
2. What is treatment and control in the experiment?
3. Consider First Difference Estimate and is it a good estimate?
4. Calculate  the  Difference-in-Differences?
5. What if the fixed ROI Calculation?


# Data Overview

## Loading Packages
```{r warning = FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(plm)
```

## Loading and Transforming data

```{r}

data_2 = read.csv("did_sponsored_ads.csv")
data_2 = data_2%>%
  mutate(treat = if_else(platform %in% c('goog'), 1, 0), 
         post = if_else(week < 10, 0, 1),
         avg_total = avg_spons+avg_org)
```


__Following data points were given for the data:__

1. id - ID of the search engine
2. platform - Name of the search engine
3. week  - Count of the week starting from 1
4. avg_spons - Count of clicks received form sponsored ads
5. avg_org - Count of clicks received from organic clicks

__Transformed variables:__
6. treatment - 1 for rows which are part of treatment else 0
7. post - 1 for weeks after 9 else 0
8. avg_total - Sum of click from sponsored and organic clicks


Sponsored clicks and organic clicks data is give for four different search engines Google, Yahoo, Bing, Ask and because of some glitch the ads on Google didn't work after week 9. Users did not see ads of Bazaar.com after week 9. So the data is zero for advertisement clicks after week 9 for Google.




## Analysis Performed

1. Pre_post difference is calculated using the first difference approach.

2. Difference-in-Differences regression is performed to get the estimate.



# Problem With Bob's ROI Calculation 

The problem with Bob's investment ROI calculation is that the return value used 
in the calculations may not be the actual value realized with the Advertisements.
User will see th is if they are searching for the specific key words related to 
Bazaar.com. So most the users may be interested in Bazaar.com and searching for 
it. So these users are not the users coming to the website just because they saw
the advertisement. These might still visit the website even if the website 
advertisement is not there and the value generated by them is not the actual 
value. 

Bob's ROI = $((21 * 0.12) - (0.6)) / (0.6) = 320% $

1. This assumes that all 100 percentage of clicks are from user who do not have intent. But that is not the case as some of the branded words are used in publishing ads so users who search and have the intent to visit the site will also see these ads.

2. Some of the user might have seen the ad but did not react immediately and later searched for the website to visit. Since it a pay per click model that cost is not incurred by Bazaar.com.


# Treatment and Control Definition

## Unit of Observation
The search engine the users are s.earching keywords

## Treatment
Treatment is the stop of sponsored ads in Google starting from week 10.

## Control
Clicks from Yahoo, Bing and Ask are used as control

# First  Difference  Estimate

Using the data of only Google first difference estimate is calculated.


## Data Distribution

```{r}
hist(data_2[data_2$platform=='goog',"avg_total"])
```
Data is skewed so we can use log transform while performing analysis.

## Analysis
```{r}

model = lm(log(avg_total)~post, data = data_2[data_2$platform=='goog',])

summary(model)

print(paste("Percentage Change: ",(exp(model$coefficients[2])-1)*100))

```
## Interpretation

From the above we get that the percentage change in the total clicks is 0.13% and the p-value is 0.998(>0.05). As the p-value is not significant we cannot conclude anything from this analysis. 


# Calculate  the  Difference-in-Differences

## Parellel Trends Assumption Check

To conduct Difference-in-Differences analysis we need to verify parallel trends assumption.

```{r}
wide_data=spread(data_2%>%select(week, platform, avg_total), platform, avg_total)
ggplot(wide_data, aes(week)) + 
  geom_line(aes(y = ask, colour = "Ask")) + 
  geom_line(aes(y = bing, colour = "Bing")) +
  geom_line(aes(y = goog, colour = "Google")) +
  geom_line(aes(y = yahoo, colour = "Yahoo")) +
  geom_vline(xintercept = 9)
```
As we can see that the data is not parallel before week 9 so the parallel trends assumption failed in this case.

As there are multiple  platforms in control group we can use synthetic control instead of DiD to calculate

## Creating Synthetic Data

```{r}
synth_model <- lm(formula=goog~yahoo+bing+ask,data=wide_data[wide_data$week<10,])
wide_data$synth <- predict(synth_model,newdata = wide_data)
summary(synth_model)

long_data = gather(wide_data, key='platform', value='avg_total', goog, synth)%>%
  select(week, platform,avg_total) %>% 
  mutate(treat = if_else(platform %in% c('goog'), 1, 0), 
         post = if_else(week < 10, 0, 1))

```

# Chcecking Parellel Trends for Synthetic Data
```{r}
ggplot(wide_data, aes(week)) +
  geom_line(aes(y = goog, colour = "Google")) +
  geom_line(aes(y = synth, colour = "Synthetic Data")) +
  geom_vline(xintercept = 9)
```
From the above plot parallel trends can be seen between synthetic data and Google data.


## Difference-in-Differences using synthetic data

```{r}

model = plm( log(avg_total) ~ post*treat, data = long_data,
             model = "within",
             effect = "twoway",
             index = c("platform","week"))

summary(model)
print((exp(model$coefficients[1])-1)*100)

```

# Interpretation
Here the value of the coefficient of the interaction term is -1.21 with p<0.05, hence we can conclude that this is significant. Using the coefficient we determine that the percentage of total users lost if ads are stopped is ~70%.


# Fixed RoI Calculation.

## Percentage users from Sponsored Ads

```{r}

data_2 %>% filter(platform=='goog') %>% summarize(mean(avg_spons)/mean(avg_total)*100)

```
From the above 57 percent users on average come from sponsored links.

## Updated Calculation
In this case we can see that the we are losing 70% of the user if we stop posting ads on Google. But on average we are paying for 58% user come from the ad clicks for which bazaar.com is paying.

So of the 100 users that visit the website:

* 70 are coming because of search ads
* 58 users are clicking on links and amount is paid for those users.

So return on Investment is:

```{r}
((21 * 0.12 * 70) - (0.6 * 58)) / (0.6 * 58)*100
```
The return on investment is 406% for the paid ads on Google.
